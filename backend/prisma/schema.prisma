// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int       @id @default(autoincrement())
  email               String    @unique
  password            String
  name                String?
  phone               String?
  address             String?
  city                String?
  zip                 String?
  emailVerified       Boolean   @default(false)
  emailVerifyToken    String?
  emailVerifyExpiry   DateTime?
  passwordResetToken  String?
  passwordResetExpiry DateTime?
  role                Role      @default(CUSTOMER)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  orders              Order[]

  @@map("users")
}

enum Role {
  ADMIN
  CUSTOMER
}

model Product {
  id                 Int         @id @default(autoincrement())
  name               String
  description        String      @db.Text
  
  // Legacy pricing (kept for backward compatibility)
  retailPrice        Decimal     @db.Decimal(10, 2)
  wholesalePrice     Decimal     @db.Decimal(10, 2)
  minQtyWholesale    Int         @default(10)
  
  imageUrl           String      @db.Text
  category           String
  stock              Int         @default(0)
  featured           Boolean     @default(false)
  
  // NEW: Default unit for India market (g, kg, pcs, dozen)
  defaultUnit        String      @default("kg")
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  orderItems         OrderItem[]
  
  // NEW: Product variants for quantity-based pricing
  variants           ProductVariant[]

  @@map("products")
}

// NEW: Product Variant Model for India-specific quantity options
model ProductVariant {
  id                 Int         @id @default(autoincrement())
  productId          Int
  product            Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Variant details (Zepto/BigBasket style)
  quantity           Decimal     @db.Decimal(10, 2)  // 500, 1, 6, 12
  unit               String                          // g, kg, pcs, dozen
  displayName        String                          // "500 g", "1 kg", "6 pcs"
  
  // Pricing in â‚¹ INR
  retailPrice        Decimal     @db.Decimal(10, 2)
  wholesalePrice     Decimal     @db.Decimal(10, 2)
  minQtyWholesale    Int         @default(10)
  
  // Stock management per variant
  stock              Int         @default(0)
  
  // Display order
  sortOrder          Int         @default(0)
  
  // Default variant (shown first)
  isDefault          Boolean     @default(false)
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  orderItems         OrderItem[]

  @@map("product_variants")
  @@index([productId])
}

model Order {
  id         Int         @id @default(autoincrement())
  userId     Int?
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  total      Decimal     @db.Decimal(10, 2)
  status     OrderStatus @default(PENDING)
  orderType  OrderType   @default(RETAIL)
  
  // Customer details
  customerName  String
  customerEmail String
  customerPhone String?
  
  // Shipping details
  shippingAddress String @db.Text
  shippingCity    String
  shippingZip     String
  
  // Payment details (nullable for backward compatibility)
  paymentStatus      PaymentStatus? @default(PENDING)
  paymentMethod      String?
  razorpayOrderId    String?
  razorpayPaymentId  String?
  razorpaySignature  String?
  paidAt             DateTime?
  
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum OrderType {
  RETAIL
  WHOLESALE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // NEW: Reference to specific variant selected
  variantId Int?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  orderType OrderType @default(RETAIL)
  
  // NEW: Store selected quantity + unit for historical record
  selectedQuantity Decimal? @db.Decimal(10, 2)
  selectedUnit     String?
  
  createdAt DateTime @default(now())

  @@map("order_items")
}

model WebsiteSettings {
  id              Int      @id @default(autoincrement())
  siteName        String   @default("Fruitify")
  logoUrl         String?  @db.Text
  tagline         String?  @db.Text
  contactEmail    String   @default("contact@fruitify.com")
  contactPhone    String?
  address         String?  @db.Text
  city            String?
  zip             String?
  footerText      String?  @db.Text
  supportEmail    String?
  facebookUrl     String?  @db.Text
  twitterUrl      String?  @db.Text
  instagramUrl    String?  @db.Text
  maintenanceMode Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("website_settings")
}
